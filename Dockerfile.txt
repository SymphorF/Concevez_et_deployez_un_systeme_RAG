# ============================================================
# üèóÔ∏è √âtape 1 ‚Äî Construction de l‚Äôenvironnement
# ============================================================
FROM python:3.11-slim AS builder

# D√©sactive le buffering Python
ENV PYTHONUNBUFFERED=1

# Cr√©e un dossier de travail
WORKDIR /app

# Copie le fichier de d√©pendances
COPY requirements.txt .

# Installe les d√©pendances dans un dossier temporaire
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir -r requirements.txt


# ============================================================
# üöÄ √âtape 2 ‚Äî Image finale l√©g√®re
# ============================================================
FROM python:3.11-slim

WORKDIR /app

# Copie uniquement ce qui est n√©cessaire depuis la premi√®re image
COPY --from=builder /usr/local/lib/python3.11 /usr/local/lib/python3.11
COPY --from=builder /usr/local/bin /usr/local/bin

# Copie le code de l‚Äôapplication
COPY . .

# Expose le port FastAPI/Uvicorn
EXPOSE 8000

# Variables d‚Äôenvironnement utiles
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PORT=8000

# Commande par d√©faut : lance le serveur FastAPI
CMD ["uvicorn", "rag_fast_api:app", "--host", "0.0.0.0", "--port", "8000"]
